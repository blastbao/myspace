---
layout: post  
title: 聊聊处理器是如何工作的 
date: 2021-03-17 02:20:12 +0800
tags: ["时钟周期","CPI","IPS"]
draft: true
---

近期突发奇想，虽然自己对内存屏障的作用、使用方式已经很清楚了，但是堆内存屏障的实现还是不清晰，我找了些资料读了些处理器架构设计相关的论文，扫除了很多疑惑。我发现处理器架构设计，对于理解一些技术细节还是非常有帮助的。

于是我就来了兴趣，希望能整理下学习到的关于处理器架构的知识点。当然这里的东西会涉及到很多，就学到一点总结一点，慢慢积累的方式。

## 指令执行相关概念

首先，需要理解一下几个时间相关的概念：振荡周期、时钟周期、机器周期、指令周期、CPI、IPS。如果读者之前有了解过计算机内部计时电路的工作原理，应该对振荡周期、时钟周期不会感到太陌生。我还是试着从头解释下这几个周期的概念。

ps：如果读者对计算机内部时钟工作原理感兴趣的话，可以参考我之前写的一篇博客：[聊聊计算机系统中的时间](https://www.hitzhangjie.pro/blog/2020-03-09-%E8%81%8A%E8%81%8A%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%97%B6%E9%97%B4/)。

![几个周期定义的概念](https://gblobscdn.gitbook.com/assets%2F-MCaQ8LxA2f21Zqi0hyL%2F-MWm_X_WblOfjEryeup1%2F-MWmq8xdHHfTXuW61FQ_%2Fimage.png?alt=media&token=d477a81d-f78b-43c8-9bdc-391595429a37)

### 振荡周期

振荡周期，实际上指的就是晶振周期。振荡周期是单片机的基本时间单位。如果，晶振频率为12MHz，则振荡周期为(1/12)us。

### 时钟周期

时钟周期，定义为时钟脉冲的倒数，是计算机中的最基本的、最小的时间单位。

在一个时钟周期内，CPU仅完成一个最基本的动作。时钟周期是计算机的基本工作脉冲，控制着计算机的工作节奏。时钟频率越高，工作速度越快。

一个时钟周期通常包括几个振荡周期，如振荡源信号经二分频后形成的时钟脉冲信号。

### 机器周期

在计算机中，长把一条指令的执行过程划分为若干个阶段，每一个阶段完成一个基本操作，完成这个基本操作所需要的时间称之为机器周期。

一条机器指令的完整执行过程，称之为指令周期。指令周期可以分为几个阶段，每个阶段称之为机器周期。

### 指令周期

执行一条指令所需要的时间，一般由若干个机器周期组成。指令不同，所需要的的机器周期一般也不相同。

通常而言，指令周期大致可以划分为如下几个机器周期：

- IF，指令预取
- ID，指令解码
- EX，指令执行
- MEM，内存访问
- WB，写回结果

### CPI: 指令平均时钟周期数

**Clock cycles per Instruction**，or Clocks per Instruction，简称CPI，表示执行一条指令所需的平均时钟周期数。现代CPU设计通常都是支持超标量流水线的，在一个机器周期内会允许完成多条指令的多个操作，以提高指令执行的效率。

![superscalar processor](https://gblobscdn.gitbook.com/assets%2F-MCaQ8LxA2f21Zqi0hyL%2F-MWm_X_WblOfjEryeup1%2F-MWmqRuZm8ZmkFcZbeDU%2Fimage.png?alt=media&token=8cf89f81-9372-4b06-8058-7f284a865a1a)

虽然指令周期包含了多个机器周期，但是由于流水线技术的引入，CPI也变小了。度量一个处理器的性能好不好，CPI就成了一个非常重要的指标。

### IPS：每秒平均执行指令数

前面提到了CPI可以用来量化CPU指令执行的效率，但是它代表的是超标量流水线的并发执行情况，并不能直观反映处理器执行指令的效率。

IPS，表示的是每秒平均执行指令数，这个相较而言更加直观，更有冲击力。我们可以直观感觉到处理器的真实执行效率。或者说，用每个时钟周期平均执行的指令的数量来表示也可以，乘以主频、核数即可得知处理器总的执行效率。

维基百科提供了一个不同处理器型号的“每秒+指定频率”、“每个时钟周期”、“每个时钟周期+单核”这3种情况下的统计数据，仅供参考：[instructions per second](https://en.wikipedia.org/wiki/Instructions_per_second)。其中可以看到Intel Core i7 920 (4-core)	2.93 GHz 时钟工作频率下，每秒可以执行的指令数为 82,300 MIPS 条MIPS表示单位为百万条。

现在来看，如果是让i7处理器跑上个1微秒，就大约可以执行82300条指令了，这个数字非常惊人。联想下我们提及的进程或者线程上下文切换开销时，实验数据显示上下文切换开销是1.2微秒（未考虑CPU亲和性），姑且先按最小的计算已经有98760条指令了，数量相当大。所以我们在工程上要特别注意尽量减少上下文切换的开销，让处理器多执行指令。


